<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>NomadAI ‚Äî Multi-Provider Hotel Concierge Showroom</title>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.2.0/marked.min.js"></script>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --primary: #00d4ff;
            --primary-dark: #0077b6;
            --accent: #7b2cbf;
            --accent-dark: #5a189a;
            --danger: #ff4757;
            --success: #4caf50;
            --bg-dark: #1a1a2e;
            --bg-darker: #16213e;
            --bg-card: rgba(255,255,255,0.04);
            --border: rgba(255,255,255,0.08);
            --radius: 14px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { height: 100%; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: #fff;
            min-height: 100%;
        }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .app {
            max-width: 900px;
            margin: 0 auto;
            padding: 16px 16px calc(var(--safe-bottom) + 16px);
            padding-top: calc(var(--safe-top) + 16px);
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        header { text-align: center; padding: 20px 0 12px; }
        .logo-row { display: flex; align-items: center; justify-content: center; gap: 10px; }
        h1 {
            font-size: 2rem; font-weight: 800;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .badge { font-size: .65rem; background: rgba(255,255,255,.1); padding: 2px 8px; border-radius: 8px; color: #888; }
        .tagline { color: #888; font-size: .85rem; margin-top: 4px; }
        .hotel-name { color: var(--primary); font-size: .95rem; font-weight: 600; margin-top: 6px; }

        /* ‚îÄ‚îÄ Capability Badges ‚îÄ‚îÄ */
        .cap-grid { display: flex; flex-wrap: wrap; gap: 8px; margin: 14px 0; justify-content: center; }
        .cap {
            display: flex; align-items: center; gap: 6px; padding: 6px 12px;
            background: rgba(255,255,255,.04); border: 1px solid var(--border); border-radius: 20px;
            font-size: .78rem; color: #aaa;
        }
        .cap .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot.green { background: var(--success); }
        .dot.blue { background: var(--primary); }
        .dot.purple { background: var(--accent); }

        /* ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ */
        .tabs {
            display: flex; gap: 4px; overflow-x: auto; padding: 14px 0 10px;
            -webkit-overflow-scrolling: touch; scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar { display: none; }
        .tab {
            flex-shrink: 0; padding: 8px 18px; border-radius: 20px; font-size: .85rem; font-weight: 600;
            border: 1px solid var(--border); background: transparent; color: #888; cursor: pointer;
            transition: all .2s; white-space: nowrap;
        }
        .tab:hover { border-color: rgba(255,255,255,.2); color: #bbb; }
        .tab.active { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; border-color: transparent; }

        /* ‚îÄ‚îÄ Panels ‚îÄ‚îÄ */
        .panel { display: none; }
        .panel.active { display: block; animation: fadeIn .25s ease; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }

        /* ‚îÄ‚îÄ Chat Panel ‚îÄ‚îÄ */
        .chat-box {
            background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border);
            height: 50vh; min-height: 280px; max-height: 500px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .chat-messages {
            flex: 1; padding: 16px; overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        .msg { margin-bottom: 12px; padding: 12px 14px; border-radius: 16px; max-width: 85%; font-size: .95rem; line-height: 1.45; animation: fadeIn .25s ease; }
        .msg.user { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); margin-left: auto; border-bottom-right-radius: 4px; }
        .msg.assistant { background: rgba(255,255,255,.08); border-bottom-left-radius: 4px; }
        .msg .lbl { font-size: .7rem; color: rgba(255,255,255,.45); margin-bottom: 3px; font-weight: 500; }
        
        /* Markdown formatting inside messages */
        .msg p { margin: 0 0 8px 0; }
        .msg p:last-child { margin-bottom: 0; }
        .msg strong { font-weight: 700; color: #fff; }
        .msg ul, .msg ol { margin: 8px 0; padding-left: 20px; }
        .msg li { margin: 4px 0; }
        .msg code { background: rgba(0,0,0,.3); padding: 2px 6px; border-radius: 4px; font-size: .9em; }
        .msg pre { background: rgba(0,0,0,.3); padding: 10px; border-radius: 8px; overflow-x: auto; margin: 8px 0; }
        .msg pre code { background: none; padding: 0; }
        .msg a { color: var(--primary); text-decoration: none; }
        .msg a:hover { text-decoration: underline; }


        .chat-controls { padding: 10px 12px; border-top: 1px solid var(--border); }
        .chat-row { display: flex; gap: 8px; }
        .chat-input {
            flex: 1; min-height: 46px; padding: 0 14px; border: none; border-radius: 12px;
            background: rgba(255,255,255,.08); color: #fff; font-size: 1rem;
        }
        .chat-input::placeholder { color: #555; }
        .chat-input:focus { outline: none; background: rgba(255,255,255,.12); }
        .btn-send {
            min-width: 60px; min-height: 46px; padding: 0 18px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dark));
            border: none; border-radius: 12px; color: #fff; font-size: .95rem; font-weight: 600; cursor: pointer;
        }
        .btn-send:active { transform: scale(.96); }

        /* Voice bar */
        .voice-bar { margin-top: 8px; }
        .btn-mic {
            width: 100%; min-height: 56px; font-size: .95rem; font-weight: 600; border: none; border-radius: 14px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
            touch-action: manipulation; transition: all .2s;
        }
        .btn-mic.idle { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #fff; }
        .btn-mic.recording { background: linear-gradient(135deg, var(--danger), #c0392b); color: #fff; animation: pulse .8s infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)} }
        .mic-icon { width: 24px; height: 24px; }

        /* ‚îÄ‚îÄ Voice Panel Layout ‚îÄ‚îÄ */
        .voice-chat-area {
            background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border);
            display: flex; flex-direction: column; height: 70vh; min-height: 350px; max-height: 600px;
            overflow: hidden;
        }
        .voice-chat-area .chat-messages { flex: 1; padding: 16px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .voice-input-bar {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 12px; border-top: 1px solid var(--border);
        }
        .voice-input-bar .btn-mic { flex: 1; min-height: 50px; }
        .voice-lang-pill {
            width: auto; min-width: 72px; padding: 8px 6px; border-radius: 10px;
            background: rgba(255,255,255,.08); border: 1px solid var(--border);
            color: #fff; font-size: .85rem; cursor: pointer;
        }
        .voice-lang-pill option { background: #1a1a2e; }
        .voice-settings-toggle {
            width: 44px; height: 44px; border-radius: 10px; border: 1px solid var(--border);
            background: rgba(255,255,255,.06); cursor: pointer; font-size: 1.1rem;
            display: flex; align-items: center; justify-content: center;
            transition: background .2s;
        }
        .voice-settings-toggle:hover { background: rgba(255,255,255,.12); }
        .voice-status-bar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 6px 12px 10px; gap: 8px;
        }
        /* Settings Drawer */
        .voice-settings-drawer {
            margin-top: 10px; border-radius: var(--radius); border: 1px solid var(--border);
            background: var(--bg-card); overflow: hidden;
            max-height: 0; opacity: 0; transition: max-height .3s ease, opacity .2s ease, margin .2s ease;
            margin-top: 0;
        }
        .voice-settings-drawer.open { max-height: 500px; opacity: 1; margin-top: 10px; }
        .voice-settings-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 14px; border-bottom: 1px solid var(--border);
            font-size: .85rem; font-weight: 600; color: #aaa;
        }
        .voice-settings-close {
            background: none; border: none; color: #666; font-size: 1rem; cursor: pointer;
            padding: 2px 6px; border-radius: 6px;
        }
        .voice-settings-close:hover { color: #fff; background: rgba(255,255,255,.1); }
        .voice-settings-body { padding: 14px; }
        .voice-settings-body .field label { color: #aaa; font-size: .8rem; }

        .chat-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 8px; gap: 8px; }
        .btn-sm {
            min-height: 36px; padding: 0 14px; border-radius: 10px; font-size: .8rem; cursor: pointer;
            border: 1px solid #444; background: transparent; color: #888; transition: all .2s;
        }
        .btn-sm:hover { background: rgba(255,255,255,.05); }
        .btn-sm:active { border-color: var(--primary); color: var(--primary); }
        .status-text { flex: 1; text-align: right; color: #555; font-size: .8rem; }
        .status-text.error { color: var(--danger); }

        /* ‚îÄ‚îÄ Tool Panels ‚îÄ‚îÄ */
        .tool-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px;
        }
        .tool-card h3 { font-size: 1.05rem; margin-bottom: 4px; }
        .tool-card .desc { font-size: .82rem; color: #888; margin-bottom: 16px; }
        .field { margin-bottom: 14px; }
        .field label { display: block; margin-bottom: 5px; color: #aaa; font-size: .85rem; }
        .field input, .field textarea, .field select {
            width: 100%; padding: 11px 14px; background: rgba(255,255,255,.07); border: 1px solid var(--border);
            border-radius: 10px; color: #fff; font-size: .95rem;
        }
        .field textarea { min-height: 90px; resize: vertical; font-family: inherit; }
        .field input::placeholder, .field textarea::placeholder { color: #555; }
        .field select option { background: #1a1a2e; color: #fff; }
        .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .btn-action {
            width: 100%; min-height: 48px; border: none; border-radius: 12px; font-size: .95rem; font-weight: 600;
            cursor: pointer; color: #fff; transition: all .2s;
        }
        .btn-action:active { transform: scale(.97); }
        .btn-action:disabled { opacity: .5; cursor: not-allowed; }
        .btn-action.primary { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); }
        .btn-action.accent { background: linear-gradient(135deg, var(--accent), var(--accent-dark)); }

        .result-box {
            margin-top: 16px; padding: 16px; background: rgba(0,212,255,.08); border: 1px solid rgba(0,212,255,.2);
            border-radius: 10px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; font-size: .9rem; line-height: 1.5;
        }
        .result-box.hidden { display: none; }
        .result-box.error { border-color: rgba(255,71,87,.3); background: rgba(255,71,87,.08); color: #ff8a8a; }

        /* ‚îÄ‚îÄ Diagnostics ‚îÄ‚îÄ */
        .diag-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; }
        .diag-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .diag-table th { text-align: left; padding: 8px 6px; color: #888; font-size: .8rem; border-bottom: 1px solid var(--border); }
        .diag-table td { padding: 8px 6px; font-size: .85rem; border-bottom: 1px solid rgba(255,255,255,.03); }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (max-width: 600px) {
            h1 { font-size: 1.6rem; }
            .chat-box { height: 45vh; }
            .grid2 { grid-template-columns: 1fr; }
        }
        @media (min-width: 768px) {
            .app { padding: 24px; }
            h1 { font-size: 2.2rem; }
        }

        /* ‚îÄ‚îÄ Provider Selector ‚îÄ‚îÄ */
        .provider-bar {
            display: flex; gap: 8px; align-items: center; justify-content: center;
            flex-wrap: wrap; margin: 10px 0 6px; padding: 10px 14px;
            background: rgba(255,255,255,.03); border: 1px solid var(--border); border-radius: 12px;
        }
        .provider-bar label { font-size: .8rem; color: #888; font-weight: 500; }
        .provider-bar select {
            padding: 6px 10px; background: rgba(255,255,255,.08); border: 1px solid var(--border);
            border-radius: 8px; color: #fff; font-size: .82rem; max-width: 240px;
        }
        .provider-bar select option { background: #1a1a2e; color: #fff; }
        .provider-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 3px 10px; border-radius: 12px; font-size: .72rem; font-weight: 600;
        }
        .provider-badge.chutes { background: rgba(123,44,191,.15); color: var(--accent); }
    </style>
</head>
<body>
<div class="app">
    <!-- Header -->
    <header>
        <div class="logo-row">
            <h1>NomadAI</h1>
            <span class="badge" id="versionBadge">v...</span>
        </div>
        <p class="tagline">AI Hotel Concierge ‚Äî Powered by Chutes.ai</p>
        <p class="hotel-name" id="hotelName">Loading...</p>

        <!-- Provider & Model selector (disabled ‚Äî brain_llm is MiMo-V2-Flash) -->
        <div class="provider-bar" id="providerBar" style="display:none;">
            <label>Provider:</label>
            <select id="providerSelect" disabled><option>Loading...</option></select>
            <label>Model:</label>
            <select id="modelSelect" disabled><option>Loading...</option></select>
            <span class="provider-badge" id="providerBadge">‚Äî</span>
        </div>

        <div class="cap-grid">
            <span class="cap"><span class="dot green"></span> Multi-Model Chat</span>
            <span class="cap"><span class="dot blue"></span> Translation</span>
            <span class="cap"><span class="dot green"></span> Skill Router</span>
            <span class="cap"><span class="dot purple"></span> DeepSeek V3</span>
            <span class="cap"><span class="dot purple"></span> Qwen3</span>
        </div>
    </header>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
        <button class="tab active" data-panel="chat">üí¨ Chat</button>
        <button class="tab" data-panel="voice">üé§ Voice</button>
        <button class="tab" data-panel="translate">üåê Translate</button>
        <button class="tab" data-panel="slides" style="display:none;">üìä Slides</button>
        <button class="tab" data-panel="video" style="display:none;">üé¨ Video</button>
        <button class="tab" data-panel="diag">üîß Diagnostics</button>
    </div>

    <!-- ‚ïê‚ïê PANEL: Chat ‚ïê‚ïê -->
    <div class="panel active" id="panel-chat">
        <div class="chat-box">
            <div class="chat-messages" id="chatMessages">
                <div class="msg assistant">
                    <div class="lbl">Concierge</div>
                    <div>Welcome! I'm your AI hotel concierge. How can I help you today?</div>
                </div>
            </div>
            <div class="chat-controls">
                <div class="chat-row">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask about rooms, WiFi, breakfast..." enterkeyhint="send">
                    <button class="btn-send" id="chatSendBtn">Send</button>
                </div>
                <div class="chat-footer">
                    <button class="btn-sm" id="resetBtn">Reset</button>
                    <button class="btn-sm" id="chatMuteBtn" title="Toggle voice output">
                        <span id="chatMuteIcon">üîá</span> <span id="chatMuteLabel">Muted</span>
                    </button>
                    <div class="status-text" id="chatStatus">Ready</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê PANEL: Voice ‚ïê‚ïê -->
    <div class="panel" id="panel-voice">
        <!-- ‚îÄ‚îÄ Chat Area ‚îÄ‚îÄ -->
        <div class="voice-chat-area">
            <div class="chat-messages" id="voiceMessages">
                <div class="msg assistant">
                    <div class="lbl">Concierge</div>
                    <div>Hold the mic button and speak ‚Äî I'll transcribe and respond.</div>
                </div>
            </div>
            <div class="voice-input-bar">
                <select id="voiceLangSelect" class="voice-lang-pill">
                    <option value="en">üá¨üáß EN</option>
                    <option value="ru">üá∑üá∫ RU</option>
                    <option value="zh">üá®üá≥ ZH</option>
                    <option value="ja">üáØüáµ JA</option>
                    <option value="ko">üá∞üá∑ KO</option>
                    <option value="es">üá™üá∏ ES</option>
                    <option value="fr">üá´üá∑ FR</option>
                    <option value="de">üá©üá™ DE</option>
                    <option value="ar">üá∏üá¶ AR</option>
                </select>
                <button class="btn-mic idle" id="micBtn">
                    <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1 1.93c-3.94-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6s6-2.69 6-6h2c0 4.08-3.06 7.44-7 7.93V19h4v2H8v-2h4v-3.07z"/></svg>
                    <span id="micText">Hold to Speak</span>
                </button>
                <button class="voice-settings-toggle" id="voiceSettingsToggle" title="Settings">‚öôÔ∏è</button>
            </div>
            <div class="voice-status-bar">
                <button class="btn-sm" id="voiceResetBtn">Reset</button>
                <div class="status-text" id="voiceStatus">Ready ‚Äî tap &amp; hold mic</div>
            </div>
        </div>

        <!-- ‚îÄ‚îÄ Settings Drawer ‚îÄ‚îÄ -->
        <div class="voice-settings-drawer" id="voiceSettingsDrawer">
            <div class="voice-settings-header">
                <span>‚öôÔ∏è Voice Settings</span>
                <button class="voice-settings-close" id="voiceSettingsClose">‚úï</button>
            </div>
            <div class="voice-settings-body">
                <div class="grid2">
                    <div class="field">
                        <label>TTS Voice</label>
                        <select id="voiceSelect">
                            <option value="kokoro">Kokoro (fast)</option>
                            <option value="csm-1b">CSM-1B (natural)</option>
                        </select>
                    </div>
                    <div class="field">
                        <label>Language</label>
                        <select id="voiceLangSelect2">
                            <option value="en">English</option>
                            <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                            <option value="zh">‰∏≠Êñá</option>
                            <option value="ja">Êó•Êú¨Ë™û</option>
                            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                            <option value="es">Espa√±ol</option>
                            <option value="fr">Fran√ßais</option>
                            <option value="de">Deutsch</option>
                            <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                        </select>
                    </div>
                </div>
                <div class="grid2">
                    <div class="field">
                        <label>VAD Sensitivity</label>
                        <input type="range" id="vadThreshold" min="0.003" max="0.03" step="0.001" value="0.01">
                        <div class="status-text" id="vadThresholdLabel">0.01</div>
                    </div>
                    <div class="field">
                        <label>Silence timeout</label>
                        <input type="range" id="vadTimeout" min="0.5" max="3" step="0.1" value="1.5">
                        <div class="status-text" id="vadTimeoutLabel">1.5s</div>
                    </div>
                </div>
                <div style="border-top:1px solid var(--border);padding-top:10px;">
                    <label style="display:flex;align-items:center;gap:8px;color:#aaa;font-size:.85rem;">
                        <input type="checkbox" id="wakeWordToggle"> üéôÔ∏è Wake Word Detection
                        <span id="wakeWordIndicator" style="width:8px;height:8px;border-radius:50%;background:#555;display:inline-block;"></span>
                    </label>
                    <div class="field" style="margin-top:6px;">
                        <label style="font-size:.75rem;">Trigger words (comma-separated)</label>
                        <input type="text" id="wakeWordInput" value="hey nomad, nomad, –ø—Ä–∏–≤–µ—Ç –Ω–æ–º–∞–¥" style="font-size:.85rem;">
                    </div>
                    <div class="status-text" id="wakeWordStatus" style="font-size:.75rem;">Wake word: off</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê PANEL: Translate ‚ïê‚ïê -->
    <div class="panel" id="panel-translate">
        <div class="tool-card">
            <h3>üåê Translation Agent</h3>
            <p class="desc">AI-powered translation via Chutes.ai ‚Äî multi-language hotel communication.</p>
            <div class="field">
                <label>Text to translate</label>
                <textarea id="trText" placeholder="What time is breakfast served?"></textarea>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>From</label>
                    <select id="trFrom">
                        <option value="auto">Auto-detect</option>
                        <option value="en">English</option>
                        <option value="zh-CN">Chinese</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
                <div class="field">
                    <label>To</label>
                    <select id="trTo">
                        <option value="zh-CN">Chinese</option>
                        <option value="en">English</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>
            </div>
            <button class="btn-action primary" id="trBtn">Translate</button>
            <div class="result-box hidden" id="trResult"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê PANEL: Slides ‚ïê‚ïê -->
    <div class="panel" id="panel-slides">
        <div class="tool-card">
            <h3>üìä Slide / Poster Agent</h3>
            <p class="desc">Slide generation ‚Äî currently unavailable with the current provider.</p>
            <div class="field">
                <label>Topic</label>
                <textarea id="slidesTopic" placeholder="Luxury hotel grand opening presentation with amenities showcase"></textarea>
            </div>
            <div class="grid2">
                <div class="field">
                    <label>Number of slides</label>
                    <input type="number" id="slidesNum" value="8" min="3" max="20">
                </div>
                <div class="field" style="display:flex;align-items:flex-end;">
                    <button class="btn-action accent" id="slidesBtn" style="width:100%">Generate Slides</button>
                </div>
            </div>
            <div class="result-box hidden" id="slidesResult"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê PANEL: Video ‚ïê‚ïê -->
    <div class="panel" id="panel-video">
        <div class="tool-card">
            <h3>üé¨ Video Effects Agent</h3>
            <p class="desc">Video generation ‚Äî currently unavailable with the current provider.</p>
            <div class="field">
                <label>Upload hotel photo</label>
                <input type="file" id="videoFile" accept="image/*" style="padding:10px;">
            </div>
            <div class="field">
                <label>Template</label>
                <select id="videoTemplate">
                    <option value="french_kiss">French Kiss</option>
                    <option value="zoom_in">Zoom In</option>
                    <option value="pan_right">Pan Right</option>
                    <option value="cinematic">Cinematic</option>
                </select>
            </div>
            <button class="btn-action accent" id="videoBtn">Generate Video</button>
            <div class="result-box hidden" id="videoResult"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê PANEL: Diagnostics ‚ïê‚ïê -->
    <div class="panel" id="panel-diag">
        <div class="diag-card">
            <h3>üîß Multi-Provider API Diagnostics</h3>
            <p class="desc">Test connectivity to Chutes.ai ‚Äî models, latency, and endpoint health.</p>
            <button class="btn-action primary" id="diagBtn">Run Diagnostics</button>

            <!-- Progress tracker -->
            <div id="diagProgress" style="display:none;margin-top:16px;">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                    <div id="diagSpinner" style="width:18px;height:18px;border:2px solid #333;border-top:2px solid var(--primary);border-radius:50%;animation:spin .8s linear infinite;"></div>
                    <span id="diagStep" style="color:var(--primary);font-size:.85rem;">Starting...</span>
                </div>
                <div id="diagLog" style="font-family:monospace;font-size:.78rem;line-height:1.7;color:#777;max-height:120px;overflow-y:auto;"></div>
            </div>
            <style>@keyframes spin{to{transform:rotate(360deg)}}</style>

            <!-- Results -->
            <div id="diagResults" style="margin-top:16px;font-family:monospace;font-size:.85rem;line-height:1.6;color:#ccc;"></div>

            <!-- Copyable raw output (shown on errors or always) -->
            <div id="diagRawWrap" style="display:none;margin-top:12px;">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                    <span style="font-size:.8rem;color:#888;">Raw output (click to copy):</span>
                    <button id="diagCopyBtn" style="background:rgba(255,255,255,.08);border:1px solid #444;color:#aaa;padding:4px 12px;border-radius:8px;font-size:.75rem;cursor:pointer;">üìã Copy</button>
                </div>
                <pre id="diagRaw" style="background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:10px;padding:12px;font-size:.78rem;color:#aaa;max-height:200px;overflow:auto;white-space:pre-wrap;word-break:break-all;cursor:pointer;user-select:all;"></pre>
            </div>
        </div>
    </div>
</div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ
const API = '';
const DEFAULT_HOTEL_ID = '2ada3c2b-b208-4599-9c46-f32dc16ff950';
const HOTEL_ID = new URLSearchParams(location.search).get('id') || DEFAULT_HOTEL_ID;
const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
let voiceEnabled = false; // runtime flag from /api/health
let ttsVoice = 'kokoro';   // runtime default from /api/health
let voiceLang = 'en';      // STT language

// ‚îÄ‚îÄ Chat TTS Mute State ‚îÄ‚îÄ
const CHAT_MUTE_KEY = 'nomadai_chat_muted';
let chatTTSMuted = localStorage.getItem(CHAT_MUTE_KEY) !== 'false'; // default: muted

// ‚îÄ‚îÄ Session Persistence ‚îÄ‚îÄ
const MAX_CONTEXT_MESSAGES = 10;
const SESSION_STORAGE_KEY = `nomadai_session_${sessionId}`;

function saveMessageToStorage(role, content) {
    try {
        const stored = JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY) || '[]');
        stored.push({ role, content, timestamp: Date.now() });
        // Keep only last 50 messages in storage (more than we send, for history)
        if (stored.length > 50) stored.shift();
        localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(stored));
    } catch (e) {
        console.warn('[storage] Failed to save message:', e);
    }
}

function getSessionContext() {
    try {
        const stored = JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY) || '[]');
        // Return last N messages for API context
        return stored.slice(-MAX_CONTEXT_MESSAGES).map(m => ({ role: m.role, content: m.content }));
    } catch (e) {
        console.warn('[storage] Failed to load context:', e);
        return [];
    }
}

function clearSessionStorage() {
    try {
        localStorage.removeItem(SESSION_STORAGE_KEY);
        console.log('[storage] Session cleared');
    } catch (e) {
        console.warn('[storage] Failed to clear session:', e);
    }
}

// ‚îÄ‚îÄ Provider state ‚îÄ‚îÄ
let currentProvider = 'chutes';
let currentModel = '';
let providersData = {};

// ‚îÄ‚îÄ DOM ‚îÄ‚îÄ
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

const chatMessages    = $('#chatMessages');
const chatInput       = $('#chatInput');
const chatSendBtn     = $('#chatSendBtn');
const resetBtn        = $('#resetBtn');
const chatMuteBtn     = $('#chatMuteBtn');
const chatMuteIcon    = $('#chatMuteIcon');
const chatMuteLabel   = $('#chatMuteLabel');
const chatStatus      = $('#chatStatus');
const voiceMessages   = $('#voiceMessages');
const micBtn          = $('#micBtn');
const micText         = $('#micText');
const voiceResetBtn   = $('#voiceResetBtn');
const voiceStatus     = $('#voiceStatus');
const voiceSelect     = $('#voiceSelect');
const voiceLangSelect = $('#voiceLangSelect');
const trBtn           = $('#trBtn');
const trResult        = $('#trResult');
const slidesBtn       = $('#slidesBtn');
const slidesResult    = $('#slidesResult');
const videoBtn        = $('#videoBtn');
const videoResult     = $('#videoResult');
const diagBtn         = $('#diagBtn');
const diagResults     = $('#diagResults');
const providerSelect  = $('#providerSelect');
const modelSelect     = $('#modelSelect');
const providerBadge   = $('#providerBadge');

// Voice UI toggles (runtime)
function disableVoiceUi() {
    const voiceTab = document.querySelector('.tab[data-panel=\"voice\"]');
    if (voiceTab) voiceTab.style.display = 'none';
    const voicePanel = $('#panel-voice');
    if (voicePanel) voicePanel.style.display = 'none';
    if (voiceStatus) voiceStatus.textContent = 'Voice disabled (ASR not configured)';
    if (micBtn) { micBtn.disabled = true; micBtn.classList.add('disabled'); }
    if (voiceResetBtn) voiceResetBtn.disabled = true;
}

function enableVoiceUi() {
    const voiceTab = document.querySelector('.tab[data-panel=\"voice\"]');
    if (voiceTab) voiceTab.style.display = '';
    const voicePanel = $('#panel-voice');
    if (voicePanel) voicePanel.style.display = '';
    if (voiceStatus) voiceStatus.textContent = 'Hold the mic to speak';
    if (micBtn) { micBtn.disabled = false; micBtn.classList.remove('disabled'); }
    if (voiceResetBtn) voiceResetBtn.disabled = false;
}

// ‚ïê‚ïê‚ïê Tabs ‚ïê‚ïê‚ïê
$$('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        $$('.tab').forEach(t => t.classList.remove('active'));
        $$('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        $(`#panel-${tab.dataset.panel}`).classList.add('active');
    });
});

// ‚ïê‚ïê‚ïê Init ‚Äî hotel branding + providers ‚ïê‚ïê‚ïê
(async function init() {
    // Load hotel info
    try {
        const res = await fetch(`${API}/api/hotel/${HOTEL_ID}`);
        if (!res.ok) throw new Error(res.status);
        const cfg = await res.json();
        $('#hotelName').textContent = cfg.name + (cfg.description ? ` ‚Äî ${cfg.description}` : '');
        document.title = cfg.name + ' ‚Äî NomadAI Showroom';
    } catch (e) {
        $('#hotelName').textContent = 'NomadAI Hotel (offline)';
        console.warn('Hotel init:', e);
    }

    // Load providers
    try {
        const res = await fetch(`${API}/api/providers`);
        if (!res.ok) throw new Error(res.status);
        const data = await res.json();
        providersData = data.providers;
        currentProvider = data.active_provider;
        currentModel = data.active_model;
        renderProviderSelectors();
    } catch (e) {
        console.warn('Provider init:', e);
        providerSelect.innerHTML = '<option value="chutes">Chutes.ai (offline)</option>';
        modelSelect.innerHTML = '<option>‚Äî</option>';
    }

    // Health: enable/disable voice
    try {
        const res = await fetch(`${API}/api/health`);
        if (!res.ok) throw new Error(res.status);
        const h = await res.json();
        voiceEnabled = !!h.asr_configured;
        if (voiceEnabled) enableVoiceUi(); else disableVoiceUi();
        ttsVoice = h.tts_model || 'kokoro';
        if (voiceSelect) voiceSelect.value = ttsVoice;
        if (h.version) $('#versionBadge').textContent = 'v' + h.version;
    } catch (e) {
        console.warn('Health init:', e);
        disableVoiceUi();
    }
})();

function renderProviderSelectors() {
    // Provider dropdown
    providerSelect.innerHTML = '';
    for (const [pid, prov] of Object.entries(providersData)) {
        if (!prov.configured) continue;
        const opt = document.createElement('option');
        opt.value = pid;
        opt.textContent = prov.name;
        if (pid === currentProvider) opt.selected = true;
        providerSelect.appendChild(opt);
    }

    // Model dropdown
    renderModelOptions();
    updateProviderBadge();
}

function renderModelOptions() {
    modelSelect.innerHTML = '';
    const prov = providersData[currentProvider];
    if (!prov) return;
    for (const m of prov.models) {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = `${m.name} ‚Äî ${m.desc}`;
        if (m.id === currentModel) opt.selected = true;
        modelSelect.appendChild(opt);
    }
}

function updateProviderBadge() {
    const prov = providersData[currentProvider];
    if (!prov) return;
    const short = currentModel.split('/').pop();
    providerBadge.textContent = `${prov.name} / ${short}`;
    providerBadge.className = `provider-badge ${currentProvider}`;
}

providerSelect.addEventListener('change', async () => {
    const newProv = providerSelect.value;
    try {
        const r = await fetch(`${API}/api/providers/switch`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ provider: newProv })
        });
        const data = await r.json();
        currentProvider = data.active_provider;
        currentModel = data.active_model;
        renderModelOptions();
        updateProviderBadge();
        setStatus(chatStatus, `Switched to ${data.provider_name}`);
    } catch (e) {
        setStatus(chatStatus, 'Switch failed', true);
    }
});

modelSelect.addEventListener('change', async () => {
    const newModel = modelSelect.value;
    try {
        const r = await fetch(`${API}/api/providers/switch`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ provider: currentProvider, model: newModel })
        });
        const data = await r.json();
        currentModel = data.active_model;
        updateProviderBadge();
        setStatus(chatStatus, `Model: ${data.active_model.split('/').pop()}`);
    } catch (e) {
        setStatus(chatStatus, 'Model switch failed', true);
    }
});

// ‚ïê‚ïê‚ïê Chat ‚ïê‚ïê‚ïê
function addMsg(container, role, text) {
    const d = document.createElement('div');
    d.className = `msg ${role}`;
    
    // Parse markdown for bot responses (keep plain text for user)
    const content = role === 'assistant' || role === 'Concierge' 
        ? marked.parse(text, { breaks: true }) 
        : text;
    
    d.innerHTML = `<div class="lbl">${role === 'user' ? 'You' : 'Concierge'}</div><div>${content}</div>`;
    container.appendChild(d);
    container.scrollTop = container.scrollHeight;
    
    // Save to localStorage for session persistence
    saveMessageToStorage(role, text);
    
    return d;
}

function addError(container, text) {
    const d = document.createElement('div');
    d.className = 'msg assistant';
    d.style.border = '1px solid rgba(255,71,87,.4)';
    d.innerHTML = `
      <div class="lbl" style="color:#ff8a8a;">Error</div>
      <div style="white-space:pre-wrap;word-break:break-word;">${text}</div>
      <button style="margin-top:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.2);background:transparent;color:#fff;border-radius:8px;cursor:pointer;font-size:.8rem;" onclick="navigator.clipboard.writeText('${text.replace(/'/g, "\\'")}').catch(()=>{})">Copy error</button>
    `;
    container.appendChild(d);
    container.scrollTop = container.scrollHeight;
}

async function sendChat() {
    const text = chatInput.value.trim();
    if (!text) return;
    chatInput.value = '';
    addMsg(chatMessages, 'user', text);
    setStatus(chatStatus, 'Thinking...');
    // Streaming via /api/chat-stream
    const streamingMsg = addMsg(chatMessages, 'assistant', '...');
    let assistantText = '';
    try {
        const context = getSessionContext();
        const r = await fetch(`${API}/api/chat-stream`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                message: text, 
                session_id: sessionId, 
                hotel_id: HOTEL_ID, 
                provider: currentProvider, 
                model: currentModel,
                context: context
            })
        });
        if (!r.ok) {
            const bodyText = await r.text();
            addError(chatMessages, `Stream failed (${r.status}): ${bodyText.slice(0,400)}`);
            setStatus(chatStatus, 'Stream error', true);
            streamingMsg.remove();
            return;
        }
        const reader = r.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            buffer += decoder.decode(value, { stream: true });
            buffer = buffer.replace(/\r/g, ''); // normalize CRLF
            let idx;
            while ((idx = buffer.indexOf('\n\n')) >= 0) {
                const rawEvent = buffer.slice(0, idx).trim();
                buffer = buffer.slice(idx + 2);
                if (!rawEvent.startsWith('data:')) continue;
                const payload = rawEvent.slice(5).trim();
                if (!payload) continue;
                let obj;
                try { obj = JSON.parse(payload); }
                catch (err) { console.warn('SSE parse error', err, payload); continue; }
                if (obj.delta) {
                    assistantText += obj.delta;
                    streamingMsg.querySelector('div:nth-child(2)').textContent = assistantText;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                if (obj.error) {
                    setStatus(chatStatus, obj.error, true);
                    streamingMsg.querySelector('div:nth-child(2)').textContent = 'Error';
                }
                if (obj.done) {
                    if (obj.text) assistantText = obj.text;
                    streamingMsg.querySelector('div:nth-child(2)').textContent = assistantText || 'No response';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    if (assistantText) speakText(assistantText);
                    setStatus(chatStatus, assistantText ? 'Ready' : 'No response', !assistantText);
                }
            }
        }
        if (!assistantText) {
            streamingMsg.querySelector('div:nth-child(2)').textContent = 'No response';
            addError(chatMessages, 'Chat stream returned no tokens. Please retry.');
        }
    } catch (e) {
        setStatus(chatStatus, 'Connection error', true);
        streamingMsg.querySelector('div:nth-child(2)').textContent = 'Error';
        addError(chatMessages, `Stream exception: ${e.message || e}`);
    }
}

chatSendBtn.addEventListener('click', sendChat);
chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); sendChat(); } });

resetBtn.addEventListener('click', async () => {
    try { await fetch(`${API}/api/reset`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({session_id:sessionId}) }); } catch(e) {}
    chatMessages.innerHTML = '<div class="msg assistant"><div class="lbl">Concierge</div><div>Conversation reset. How can I help?</div></div>';
    setStatus(chatStatus, 'Ready');
    clearSessionStorage(); // Clear localStorage
});

// ‚ïê‚ïê‚ïê Chat TTS Mute Toggle ‚ïê‚ïê‚ïê
function updateMuteButton() {
    if (chatTTSMuted) {
        chatMuteIcon.textContent = 'üîá';
        chatMuteLabel.textContent = 'Muted';
        chatMuteBtn.style.color = '#888';
    } else {
        chatMuteIcon.textContent = 'üîä';
        chatMuteLabel.textContent = 'Sound On';
        chatMuteBtn.style.color = 'var(--primary)';
    }
}

chatMuteBtn.addEventListener('click', () => {
    chatTTSMuted = !chatTTSMuted;
    localStorage.setItem(CHAT_MUTE_KEY, chatTTSMuted.toString());
    updateMuteButton();
    
    // Cancel any ongoing speech
    if (chatTTSMuted && 'speechSynthesis' in window) {
        speechSynthesis.cancel();
    }
    
    console.log('[TTS] Chat mute:', chatTTSMuted);
});

// Initialize mute button state
updateMuteButton();

// ‚ïê‚ïê‚ïê Voice ‚ïê‚ïê‚ïê
let mediaRecorder, audioChunks = [], isRecording = false;
let micStream = null;
let audioCtx = null;
let analyser = null;
let vadSilenceFrames = 0;
let vadThreshold = 0.01;      // RMS threshold for silence
let vadTimeoutSec = 1.5;      // seconds of silence before auto-stop

async function initMic() {
    if (!voiceEnabled) return;
    micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true } });
    const mime = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/webm';
    mediaRecorder = new MediaRecorder(micStream, { mimeType: mime });
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) audioChunks.push(e.data); };
    mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: mime });
        audioChunks = [];
        await sendVoice(blob);
    };
}

function startRec() {
    if (!voiceEnabled) {
        setStatus(voiceStatus, 'Voice disabled (ASR not configured)', true);
        return;
    }
    
    // Stop any playing audio when user wants to speak
    stopAllAudio();
    
    if (!micStream) { initMic().then(startRec); return; }
    if (!mediaRecorder || mediaRecorder.state !== 'inactive') return;
    audioChunks = [];
    mediaRecorder.start();
    isRecording = true;
    if (navigator.vibrate) navigator.vibrate(15);
    micBtn.className = 'btn-mic recording';
    micText.textContent = 'Release to Send';
    setStatus(voiceStatus, 'Listening...');
    startVad();
}

function stopRec() {
    if (!voiceEnabled) return;
    if (!isRecording) return;
    mediaRecorder.stop();
    isRecording = false;
    if (navigator.vibrate) navigator.vibrate([10,50,10]);
    micBtn.className = 'btn-mic idle';
    micText.textContent = 'Hold to Speak';
    setStatus(voiceStatus, 'Processing...');
    stopVad();
}

// Audio queue for streaming TTS playback
let audioQueue = [];
let isPlayingQueue = false;
let currentAudio = null; // Track currently playing audio

async function playAudioQueue() {
    if (isPlayingQueue) return;
    isPlayingQueue = true;
    while (audioQueue.length > 0) {
        const b64 = audioQueue.shift();
        await new Promise(resolve => {
            currentAudio = new Audio('data:audio/wav;base64,' + b64);
            currentAudio.onended = () => { currentAudio = null; resolve(); };
            currentAudio.onerror = () => { currentAudio = null; resolve(); };
            currentAudio.play().catch(() => { currentAudio = null; resolve(); });
        });
    }
    isPlayingQueue = false;
    currentAudio = null;
}

function stopAllAudio() {
    // Stop currently playing audio
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
    // Clear audio queue
    audioQueue = [];
    isPlayingQueue = false;
}

async function sendVoice(blob) {
    if (!voiceEnabled) return;
    const reader = new FileReader();
    reader.readAsDataURL(blob);
    reader.onloadend = async () => {
        const b64Audio = reader.result.split(',')[1];
        const useStreaming = true;

        try {
            if (useStreaming) {
                // Streaming TTS mode
                setStatus(voiceStatus, 'Thinking...');
                const context = getSessionContext();
                const r = await fetch(`${API}/api/voice-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        audio_base64: b64Audio, 
                        session_id: sessionId, 
                        hotel_id: HOTEL_ID, 
                        tts_voice: ttsVoice, 
                        language: voiceLang, 
                        stream_tts: true,
                        context: context
                    })
                });

                const eventReader = r.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                audioQueue = [];

                while (true) {
                    const { done, value } = await eventReader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        try {
                            const evt = JSON.parse(line.slice(6));
                            if (evt.type === 'transcription') {
                                addMsg(voiceMessages, 'user', evt.text);
                                setStatus(voiceStatus, 'Speaking...');
                            } else if (evt.type === 'response') {
                                addMsg(voiceMessages, 'assistant', evt.text);
                            } else if (evt.type === 'audio_chunk') {
                                audioQueue.push(evt.audio_base64);
                                playAudioQueue();
                            } else if (evt.type === 'done') {
                                setStatus(voiceStatus, 'Ready');
                            }
                        } catch(e) {}
                    }
                }
            } else {
                // Non-streaming fallback
                const context = getSessionContext();
                const r = await fetch(`${API}/api/voice-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        audio_base64: b64Audio, 
                        session_id: sessionId, 
                        hotel_id: HOTEL_ID, 
                        tts_voice: ttsVoice, 
                        language: voiceLang,
                        context: context
                    })
                });
                const data = await r.json();
                if (data.success) {
                    addMsg(voiceMessages, 'user', data.transcription);
                    addMsg(voiceMessages, 'assistant', data.response);
                    if (data.audio_base64) playBase64Audio(data.audio_base64);
                    else speakText(data.response);
                    setStatus(voiceStatus, 'Ready');
                } else {
                    setStatus(voiceStatus, data.error || 'Error', true);
                }
            }
        } catch (e) {
            setStatus(voiceStatus, 'Connection error', true);
        }
    };
}

// Touch
micBtn.addEventListener('touchstart', e => { e.preventDefault(); if (!mediaRecorder) initMic().then(startRec); else startRec(); }, { passive:false });
micBtn.addEventListener('touchend', e => { e.preventDefault(); stopRec(); }, { passive:false });
micBtn.addEventListener('touchcancel', stopRec);
// Mouse
micBtn.addEventListener('mousedown', () => { if (!mediaRecorder) initMic().then(startRec); else startRec(); });
micBtn.addEventListener('mouseup', stopRec);
micBtn.addEventListener('mouseleave', () => { if (isRecording) stopRec(); });

voiceResetBtn.addEventListener('click', async () => {
    try { await fetch(`${API}/api/reset`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({session_id:sessionId}) }); } catch(e) {}
    voiceMessages.innerHTML = '<div class="msg assistant"><div class="lbl">Concierge</div><div>Conversation reset. Hold the mic to speak.</div></div>';
    setStatus(voiceStatus, 'Ready');
    clearSessionStorage(); // Clear localStorage
});

voiceSelect.addEventListener('change', () => {
    ttsVoice = voiceSelect.value;
});
voiceLangSelect.addEventListener('change', () => {
    voiceLang = voiceLangSelect.value;
    const s2 = $('#voiceLangSelect2');
    if (s2) s2.value = voiceLang;
});
// Sync settings-drawer lang select back to pill
const voiceLangSelect2 = $('#voiceLangSelect2');
if (voiceLangSelect2) {
    voiceLangSelect2.addEventListener('change', () => {
        voiceLang = voiceLangSelect2.value;
        voiceLangSelect.value = voiceLang;
    });
}
// Settings drawer toggle
const settingsDrawer = $('#voiceSettingsDrawer');
$('#voiceSettingsToggle').addEventListener('click', () => settingsDrawer.classList.toggle('open'));
$('#voiceSettingsClose').addEventListener('click', () => settingsDrawer.classList.remove('open'));

const vadThresholdInput = $('#vadThreshold');
const vadTimeoutInput = $('#vadTimeout');
const vadThresholdLabel = $('#vadThresholdLabel');
const vadTimeoutLabel = $('#vadTimeoutLabel');

if (vadThresholdInput) {
    vadThresholdInput.addEventListener('input', () => {
        vadThreshold = parseFloat(vadThresholdInput.value);
        vadThresholdLabel.textContent = vadThreshold.toFixed(3);
    });
    vadThresholdLabel.textContent = parseFloat(vadThresholdInput.value).toFixed(3);
}
if (vadTimeoutInput) {
    vadTimeoutInput.addEventListener('input', () => {
        vadTimeoutSec = parseFloat(vadTimeoutInput.value);
        vadTimeoutLabel.textContent = vadTimeoutSec.toFixed(1) + 's';
    });
    vadTimeoutLabel.textContent = parseFloat(vadTimeoutInput.value).toFixed(1) + 's';
}

// Simple client-side VAD: stop if silence > ~1.5s
function startVad() {
    if (!micStream) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const source = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    source.connect(analyser);
    const data = new Uint8Array(analyser.fftSize);
    vadSilenceFrames = 0;

    function tick() {
        if (!analyser) return;
        analyser.getByteTimeDomainData(data);
        let sum = 0;
        for (let i = 0; i < data.length; i++) {
            const v = (data[i] - 128) / 128;
            sum += v * v;
        }
        const rms = Math.sqrt(sum / data.length);
        if (rms < vadThreshold) vadSilenceFrames++; else vadSilenceFrames = 0;
        const limitFrames = Math.floor((vadTimeoutSec * 1000) / (1000/60)); // ~60 fps
        if (vadSilenceFrames > limitFrames && isRecording) {
            stopRec();
            return;
        }
        requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
}

function stopVad() {
    vadSilenceFrames = 0;
    if (analyser) analyser.disconnect();
    analyser = null;
    if (audioCtx) { audioCtx.close(); audioCtx = null; }
}

// Play base64 audio (wav) helper
function playBase64Audio(b64) {
    const audio = new Audio('data:audio/wav;base64,' + b64);
    audio.play().catch(()=>{});
}

// ‚ïê‚ïê‚ïê Wake Word Detection ‚ïê‚ïê‚ïê
let wakeWordActive = false;
let wakeWordRecognition = null;
const wakeWordToggle = $('#wakeWordToggle');
const wakeWordIndicator = $('#wakeWordIndicator');
const wakeWordInput = $('#wakeWordInput');
const wakeWordStatus = $('#wakeWordStatus');

function getWakeWords() {
    return (wakeWordInput?.value || 'hey nomad,nomad').split(',').map(w => w.trim().toLowerCase()).filter(Boolean);
}

function startWakeWordDetection() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        wakeWordStatus.textContent = 'Wake word: not supported in this browser';
        wakeWordToggle.checked = false;
        return;
    }

    wakeWordRecognition = new SpeechRecognition();
    wakeWordRecognition.continuous = true;
    wakeWordRecognition.interimResults = true;
    wakeWordRecognition.lang = 'en-US';

    wakeWordRecognition.onresult = (event) => {
        const wakeWords = getWakeWords();
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript.toLowerCase().trim();
            for (const trigger of wakeWords) {
                if (transcript.includes(trigger)) {
                    // Wake word detected!
                    wakeWordIndicator.style.background = '#f9e2af';
                    wakeWordStatus.textContent = `Heard: "${trigger}" ‚Äî recording...`;
                    if (navigator.vibrate) navigator.vibrate([20, 100, 20]);
                    // Stop wake word, start recording
                    stopWakeWordDetection(true);
                    setTimeout(() => {
                        if (!mediaRecorder) initMic().then(() => { startRec(); scheduleWakeWordResume(); });
                        else { startRec(); scheduleWakeWordResume(); }
                    }, 200);
                    return;
                }
            }
        }
    };

    wakeWordRecognition.onend = () => {
        // Auto-restart if still active
        if (wakeWordActive && !isRecording) {
            try { wakeWordRecognition.start(); } catch(e) {}
        }
    };

    wakeWordRecognition.onerror = (e) => {
        if (e.error === 'not-allowed') {
            wakeWordStatus.textContent = 'Wake word: microphone permission denied';
            wakeWordToggle.checked = false;
            wakeWordActive = false;
            return;
        }
        // Auto-restart on other errors
        if (wakeWordActive) {
            setTimeout(() => {
                try { wakeWordRecognition.start(); } catch(ex) {}
            }, 500);
        }
    };

    wakeWordActive = true;
    wakeWordIndicator.style.background = '#a6e3a1';
    wakeWordIndicator.style.animation = 'pulse 2s infinite';
    wakeWordStatus.textContent = `Listening for: ${getWakeWords().join(', ')}`;
    try { wakeWordRecognition.start(); } catch(e) {}
}

function stopWakeWordDetection(temporary = false) {
    if (wakeWordRecognition) {
        try { wakeWordRecognition.stop(); } catch(e) {}
    }
    if (!temporary) {
        wakeWordActive = false;
        wakeWordIndicator.style.background = '#555';
        wakeWordIndicator.style.animation = 'none';
        wakeWordStatus.textContent = 'Wake word: off';
    }
}

function scheduleWakeWordResume() {
    // After recording finishes and response plays, resume wake word
    const checkInterval = setInterval(() => {
        if (!isRecording && wakeWordActive) {
            clearInterval(checkInterval);
            setTimeout(() => {
                wakeWordIndicator.style.background = '#a6e3a1';
                wakeWordStatus.textContent = `Listening for: ${getWakeWords().join(', ')}`;
                try { wakeWordRecognition.start(); } catch(e) {}
            }, 1000);
        }
    }, 500);
}

if (wakeWordToggle) {
    wakeWordToggle.addEventListener('change', () => {
        if (wakeWordToggle.checked) startWakeWordDetection();
        else stopWakeWordDetection();
    });
}

// ‚ïê‚ïê‚ïê Translate ‚ïê‚ïê‚ïê
trBtn.addEventListener('click', async () => {
    const text = $('#trText').value.trim();
    if (!text) return;
    trResult.classList.remove('hidden','error');
    trResult.textContent = 'Translating...';
    trBtn.disabled = true;
    try {
        const r = await fetch(`${API}/api/translate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text, source_lang: $('#trFrom').value, target_lang: $('#trTo').value })
        });
        const data = await r.json();
        if (data.success) {
            trResult.textContent = data.translation;
        } else {
            trResult.textContent = data.error || 'Translation failed';
            trResult.classList.add('error');
        }
    } catch (e) {
        trResult.textContent = 'Connection error: ' + e.message;
        trResult.classList.add('error');
    }
    trBtn.disabled = false;
});

// ‚ïê‚ïê‚ïê Slides ‚ïê‚ïê‚ïê
slidesBtn.addEventListener('click', async () => {
    const topic = $('#slidesTopic').value.trim();
    if (!topic) return;
    slidesResult.classList.remove('hidden','error');
    slidesResult.textContent = 'Generating slides... (this may take a minute)';
    slidesBtn.disabled = true;
    try {
        const r = await fetch(`${API}/api/generate-slides`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ topic, num_slides: parseInt($('#slidesNum').value) || 8 })
        });
        const data = await r.json();
        if (data.success) {
            slidesResult.textContent = data.slides;
        } else {
            slidesResult.textContent = data.error || 'Slide generation failed';
            slidesResult.classList.add('error');
        }
    } catch (e) {
        slidesResult.textContent = 'Connection error: ' + e.message;
        slidesResult.classList.add('error');
    }
    slidesBtn.disabled = false;
});

// ‚ïê‚ïê‚ïê Video ‚ïê‚ïê‚ïê
videoBtn.addEventListener('click', async () => {
    const fileInput = $('#videoFile');
    if (!fileInput.files.length) { alert('Please select an image first'); return; }
    videoResult.classList.remove('hidden','error');
    videoResult.textContent = 'Generating video... (this may take a while)';
    videoBtn.disabled = true;
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onloadend = async () => {
        const b64 = reader.result.split(',')[1];
        try {
            const r = await fetch(`${API}/api/generate-video`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image_base64: b64, template: $('#videoTemplate').value })
            });
            const data = await r.json();
            if (data.success) {
                if (data.video_url && data.video_url !== 'Processing...') {
                    videoResult.innerHTML = `<a href="${data.video_url}" target="_blank" style="color:var(--primary)">Download Video</a><br>Status: ${data.status}`;
                } else {
                    videoResult.textContent = 'Video is processing. Check back later.';
                }
            } else {
                videoResult.textContent = data.error || 'Video generation failed';
                videoResult.classList.add('error');
            }
        } catch (e) {
            videoResult.textContent = 'Connection error: ' + e.message;
            videoResult.classList.add('error');
        }
        videoBtn.disabled = false;
    };
});

// ‚ïê‚ïê‚ïê Diagnostics ‚ïê‚ïê‚ïê
const diagProgress = $('#diagProgress');
const diagSpinner  = $('#diagSpinner');
const diagStep     = $('#diagStep');
const diagLog      = $('#diagLog');
const diagRawWrap  = $('#diagRawWrap');
const diagRaw      = $('#diagRaw');
const diagCopyBtn  = $('#diagCopyBtn');

function diagLogLine(text, color) {
    const ts = new Date().toLocaleTimeString();
    diagLog.innerHTML += `<div><span style="color:#555;">[${ts}]</span> <span style="color:${color||'#999'};">${text}</span></div>`;
    diagLog.scrollTop = diagLog.scrollHeight;
}

function diagShowRaw(obj) {
    const txt = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    diagRaw.textContent = txt;
    diagRawWrap.style.display = 'block';
}

diagCopyBtn.addEventListener('click', async () => {
    try {
        await navigator.clipboard.writeText(diagRaw.textContent);
        diagCopyBtn.textContent = '‚úÖ Copied!';
        setTimeout(() => { diagCopyBtn.textContent = 'üìã Copy'; }, 2000);
    } catch {
        // fallback: select all text
        const range = document.createRange();
        range.selectNodeContents(diagRaw);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    }
});

diagBtn.addEventListener('click', async () => {
    // Reset
    diagResults.innerHTML = '';
    diagRawWrap.style.display = 'none';
    diagLog.innerHTML = '';
    diagProgress.style.display = 'block';
    diagSpinner.style.display = 'block';
    diagBtn.disabled = true;
    diagBtn.textContent = 'Running...';

    const t0 = performance.now();
    diagStep.textContent = 'Testing all providers...';
    diagLogLine('‚Üí Sending request to /api/ping', 'var(--primary)');

    let rawData = null;
    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 90000);
        diagLogLine('‚è± Timeout set to 90s (testing multiple providers)', '#555');

        const r = await fetch(`${API}/api/ping`, { signal: controller.signal });
        clearTimeout(timeout);
        const elapsed = ((performance.now() - t0) / 1000).toFixed(1);
        diagLogLine(`‚Üê Response received (${elapsed}s, HTTP ${r.status})`, r.ok ? 'var(--success)' : 'var(--danger)');

        if (!r.ok) {
            const errText = await r.text();
            diagStep.textContent = 'Server returned an error';
            diagSpinner.style.display = 'none';
            diagResults.innerHTML = `<div style="background:rgba(255,71,87,.1);border:1px solid rgba(255,71,87,.3);border-radius:10px;padding:16px;">
                <div style="color:var(--danger);font-weight:600;margin-bottom:8px;">‚ùå Server Error (HTTP ${r.status})</div>
                <div style="color:#ccc;font-size:.85rem;">Check server terminal for traceback.</div>
            </div>`;
            diagShowRaw({ http_status: r.status, body: errText });
            diagBtn.disabled = false; diagBtn.textContent = 'Run Diagnostics';
            return;
        }

        diagStep.textContent = 'Parsing response...';
        const data = await r.json();
        rawData = data;
        diagLogLine('‚úì JSON parsed', 'var(--success)');

        let html = '';

        // Active provider info
        html += `<div style="margin-bottom:14px;padding:10px;background:rgba(0,212,255,.06);border:1px solid rgba(0,212,255,.15);border-radius:8px;">
            <span style="color:var(--primary);font-weight:600;">Active:</span>
            <span style="color:#ddd;">${data.active_provider}</span> /
            <span style="color:#aaa;">${data.active_model}</span>
        </div>`;

        // Render each provider
        const providerNames = { chutes: 'Chutes.ai' };
        const providerColors = { chutes: 'var(--accent)' };

        for (const [pid, prov] of Object.entries(data.providers || {})) {
            const pcolor = providerColors[pid] || '#ccc';
            const pname = providerNames[pid] || pid;
            const keyOk = prov.api_key === 'configured';

            html += `<div style="margin-bottom:18px;padding:14px;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:12px;">`;
            html += `<div style="font-weight:700;color:${pcolor};font-size:1rem;margin-bottom:8px;">${pname}</div>`;
            html += `<div style="margin-bottom:8px;">API Key: <span style="color:${keyOk ? 'var(--success)' : 'var(--danger)'}; font-weight:600;">${prov.api_key || 'unknown'}</span></div>`;

            if (prov.network) {
                const n = prov.network;
                const netOk = n.status === 'ok';
                html += `<div style="margin-bottom:8px;">Network: <span style="color:${netOk ? 'var(--success)' : 'var(--danger)'};">${n.status}</span> (${n.latency_ms}ms)
                    ${n.detail ? `<div style="color:#ff9800;font-size:.8rem;">${n.detail}</div>` : ''}
                </div>`;
                diagLogLine(`[${pname}] Network: ${n.status} (${n.latency_ms}ms)`, netOk ? 'var(--success)' : 'var(--danger)');
            }

            if (prov.tests && prov.tests.length > 0) {
                html += '<table class="diag-table"><tr><th>Model</th><th>Status</th><th>Detail</th><th>Ms</th></tr>';
                for (const t of prov.tests) {
                    const ok = t.status === 'ok';
                    const skip = t.status === 'skip';
                    const color = ok ? 'var(--success)' : skip ? '#888' : 'var(--danger)';
                    const icon = ok ? '‚úÖ' : skip ? '‚è≠' : '‚ùå';
                    const detail = t.reply || t.code || t.detail || '';
                    let explain = '';
                    if (String(t.code || t.detail || '').includes('1113')) explain = ' (no balance)';
                    else if (String(t.detail || '').includes('Timeout')) explain = ' (unreachable)';
                    else if (String(t.detail || '').includes('1110')) explain = ' (bad key)';

                    html += `<tr>
                        <td style="color:#ddd;font-size:.8rem;">${t.model}</td>
                        <td style="color:${color};">${icon}</td>
                        <td style="color:#aaa;font-size:.75rem;max-width:200px;word-break:break-all;">${String(detail).substring(0, 120)}${explain ? `<span style="color:#ff9800;">${explain}</span>` : ''}</td>
                        <td style="color:#888;">${t.latency_ms || '-'}</td>
                    </tr>`;
                    diagLogLine(`  ${t.model}: ${t.status}${explain}`, color);
                }
                html += '</table>';
            }
            html += '</div>';
        }

        const totalMs = ((performance.now() - t0) / 1000).toFixed(1);
        html += `<div style="margin-top:12px;font-size:.78rem;color:#555;">Completed in ${totalMs}s</div>`;
        diagResults.innerHTML = html;
        diagLogLine(`Done in ${totalMs}s`, 'var(--success)');
        diagShowRaw(data);

    } catch (e) {
        const elapsed = ((performance.now() - t0) / 1000).toFixed(1);
        diagLogLine(`FATAL: ${e.message} (${elapsed}s)`, 'var(--danger)');
        diagStep.textContent = 'Request failed';

        let explanation = '';
        if (e.name === 'AbortError') {
            explanation = 'Timed out after 90s. Backend may be hanging.';
        } else if (e.message.includes('Failed to fetch')) {
            explanation = 'Cannot connect to backend. Make sure server is running (make server).';
        } else {
            explanation = 'Unexpected error contacting backend.';
        }

        diagResults.innerHTML = `<div style="background:rgba(255,71,87,.1);border:1px solid rgba(255,71,87,.3);border-radius:10px;padding:16px;">
            <div style="color:var(--danger);font-weight:600;margin-bottom:8px;">‚ùå ${e.name}: ${e.message}</div>
            <div style="color:#ccc;font-size:.85rem;">${explanation}</div>
        </div>`;
        diagShowRaw({ error: e.message, name: e.name, elapsed_s: elapsed, hint: explanation });
    }

    diagSpinner.style.display = 'none';
    diagStep.textContent = 'Finished';
    diagBtn.disabled = false;
    diagBtn.textContent = 'Run Diagnostics';
});

// ‚ïê‚ïê‚ïê Helpers ‚ïê‚ïê‚ïê
function setStatus(el, msg, isError = false) {
    el.textContent = msg;
    el.className = isError ? 'status-text error' : 'status-text';
}

function speakText(text) {
    // Check if chat TTS is muted
    if (chatTTSMuted) {
        console.log('[TTS] Muted, skipping speech');
        return;
    }
    
    if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text.replace(/\[.*?\]/g, ''));
        u.rate = 0.95;
        speechSynthesis.speak(u);
    }
}

document.body.addEventListener('touchmove', e => {
    if (e.target.closest('.chat-messages')) return;
    if (document.body.scrollTop === 0) e.preventDefault();
}, { passive: false });
</script>
</body>
</html>
