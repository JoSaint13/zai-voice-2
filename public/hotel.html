<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Concierge</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5; 
            height: 100vh;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-widget {
            width: 100%; height: 100%;
            max-width: 480px; max-height: 800px;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
            overflow: hidden;
            border-radius: 0;
        }
        @media (min-width: 480px) {
            .chat-widget { height: 90vh; border-radius: 20px; }
        }
        header {
            background: #333; /* Default, will be updated */
            color: white; padding: 20px;
            text-align: center; position: relative;
            transition: background 0.5s;
        }
        header h1 { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; }
        header .subtitle { font-size: 0.8rem; opacity: 0.8; }
        .chat-container {
            flex: 1; padding: 20px;
            overflow-y: auto; background: #f9f9f9;
        }
        .message {
            margin-bottom: 15px; max-width: 85%;
            animation: fadeIn 0.3s ease; position: relative;
            padding: 12px 16px; font-size: 0.95rem; line-height: 1.4;
        }
        .message.user {
            margin-left: auto; background: #333; /* Default */
            color: white; border-radius: 18px 18px 0 18px;
        }
        .message.assistant {
            margin-right: auto; background: white;
            border: 1px solid #e0e0e0; color: #333;
            border-radius: 18px 18px 18px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .sender-name { font-size: 0.7rem; color: #999; margin-bottom: 4px; display: block; }
        .message.user .sender-name { display: none; }
        
        .input-area {
            padding: 15px; background: white;
            border-top: 1px solid #eee; display: flex; gap: 10px;
        }
        input[type="text"] {
            flex: 1; padding: 12px 15px;
            border: 1px solid #ddd; border-radius: 25px;
            font-size: 1rem; outline: none;
        }
        button {
            background: #333; color: white; border: none;
            width: 45px; height: 45px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .status { font-size: 0.75rem; color: #999; text-align: center; padding: 5px; min-height: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="chat-widget">
        <header id="header">
            <h1 id="hotelName">Loading...</h1>
            <div class="subtitle" id="hotelDesc">AI Concierge</div>
        </header>

        <div class="chat-container" id="chatContainer">
            <!-- Messages go here -->
        </div>
        
        <div id="status" class="status"></div>

        <div class="input-area">
            <input type="text" id="textInput" placeholder="How can I help you?" onkeypress="handleKeyPress(event)">
            <button id="sendBtn" onclick="sendMessage()">âž¤</button>
        </div>
    </div>

    <script>
        // Utilities
        const getParams = () => new URLSearchParams(window.location.search);
        
        // Configuration
        const DEFAULT_ID = "2ada3c2b-b208-4599-9c46-f32dc16ff950"; // Fallback ID
        const HOTEL_ID = getParams().get('id') || DEFAULT_ID;
        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        
        const ui = {
            header: document.getElementById('header'),
            name: document.getElementById('hotelName'),
            desc: document.getElementById('hotelDesc'),
            chat: document.getElementById('chatContainer'),
            input: document.getElementById('textInput'),
            btn: document.getElementById('sendBtn'),
            status: document.getElementById('status')
        };

        // Initialize
        async function init() {
            try {
                const res = await fetch(`/api/hotel/${HOTEL_ID}`);
                if (!res.ok) throw new Error("Hotel not found");
                const config = await res.json();
                
                // Apply branding
                ui.name.textContent = config.name;
                ui.desc.textContent = config.description;
                document.title = config.name + " Concierge";
                
                if (config.theme_color) {
                    ui.header.style.background = config.theme_color;
                    ui.btn.style.background = config.theme_color;
                    // Dynamic style for user messages
                    const style = document.createElement('style');
                    style.innerHTML = `.message.user { background-color: ${config.theme_color} !important; }`;
                    document.head.appendChild(style);
                }
                
                addMessage('assistant', `Welcome to ${config.name}. How can I assist you today?`);
            } catch (e) {
                console.error(e);
                ui.name.textContent = "Error";
                ui.desc.textContent = "Could not load hotel data";
            }
        }

        async function sendMessage() {
            const text = ui.input.value.trim();
            if (!text) return;
            
            ui.input.value = '';
            addMessage('user', text);
            ui.status.textContent = 'Concierge is typing...';

            try {
                const response = await fetch(`/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: text, 
                        session_id: sessionId,
                        hotel_id: HOTEL_ID 
                    })
                });
                
                const data = await response.json();
                ui.status.textContent = '';
                
                if (data.success) {
                    addMessage('assistant', data.response);
                } else {
                    addMessage('assistant', "I'm having trouble connecting right now.");
                }
            } catch (err) {
                ui.status.textContent = '';
                addMessage('assistant', "Connection error.");
            }
        }

        function addMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerHTML = `<span class="sender-name">${role === 'user' ? 'You' : 'Concierge'}</span>${text}`;
            ui.chat.appendChild(div);
            ui.chat.scrollTop = ui.chat.scrollHeight;
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

        init();
    </script>
</body>
</html>
